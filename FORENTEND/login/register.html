<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Study Tracker</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>üìö Study Tracker</h1>
            <p>Create your account</p>
        </div>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <!-- Registration Form -->
        <form id="registerForm" class="login-form">
            <div class="form-group">
                <label for="username" class="required">Username</label>
                <input type="text" id="username" name="username" class="form-input" 
                       placeholder="Choose a username" required minlength="3" maxlength="30">
            </div>

            <div class="form-group">
                <label for="email" class="required">Email</label>
                <input type="email" id="email" name="email" class="form-input" 
                       placeholder="Enter your email" required>
            </div>

            <div class="form-group">
                <label for="password" class="required">Password</label>
                <input type="password" id="password" name="password" class="form-input" 
                       placeholder="Create a password" required minlength="6">
            </div>

            <div class="form-group">
                <label for="firstName" class="required">First Name</label>
                <input type="text" id="firstName" name="firstName" class="form-input" 
                       placeholder="Your first name" required maxlength="50">
            </div>

            <div class="form-group">
                <label for="lastName" class="required">Last Name</label>
                <input type="text" id="lastName" name="lastName" class="form-input" 
                       placeholder="Your last name" required maxlength="50">
            </div>

            <button type="submit" class="login-btn">üìù Register</button>

            <div class="form-footer">
                Already have an account? <a href="login.html">Login here</a>
            </div>
        </form>

        <!-- OTP Verification Form (Hidden initially) -->
        <form id="otpForm" class="login-form hidden-form">
            <div class="otp-header">
                <h3>üìß Email Verification</h3>
                <p>We've sent a 6-digit OTP to <span id="userEmail"></span></p>
                <p>Please check your email and enter the OTP below:</p>
            </div>

            <div class="form-group">
                <label for="otpCode" class="required">OTP Code</label>
                <input type="text" id="otpCode" name="otp_code" class="form-input otp-input" 
                       placeholder="Enter 6-digit OTP" maxlength="6" required>
                <div class="form-help">OTP expires in 10 minutes</div>
            </div>

            <button type="submit" class="login-btn">‚úì Verify OTP</button>
        </form>
    </div>

    <script src="../js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const otpForm = document.getElementById('otpForm');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const userEmailSpan = document.getElementById('userEmail');
            
            let userEmail = '';

            // Registration form submission
            registerForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                errorMessage.textContent = '';
                successMessage.textContent = '';

                try {
                    const userData = {
                        username: document.getElementById('username').value,
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value,
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value
                    };

                    const response = await window.api.auth.register(userData);

                    if (response.success) {
                        userEmail = userData.email;
                        userEmailSpan.textContent = userEmail;
                        registerForm.style.display = 'none';
                        otpForm.style.display = 'block';
                        successMessage.textContent = response.message;
                    } else {
                        errorMessage.textContent = response.message || 'Registration failed';
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    errorMessage.textContent = 'Registration failed. Please try again.';
                }
            });

            // OTP verification form submission
            otpForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                errorMessage.textContent = '';
                successMessage.textContent = '';

                try {
                    const otpData = {
                        email: userEmail,
                        otp: document.getElementById('otpCode').value
                    };

                    const response = await window.api.auth.verifyOTP(otpData);

                    if (response.success) {
                        successMessage.textContent = response.message;
                        // Redirect to login page after successful verification
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        errorMessage.textContent = response.message || 'OTP verification failed';
                    }
                } catch (error) {
                    console.error('OTP verification error:', error);
                    errorMessage.textContent = 'OTP verification failed. Please try again.';
                }
            });
        });
    </script>
</body>
</html>